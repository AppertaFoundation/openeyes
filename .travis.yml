language: generic
dist: focal


before_script:
    - export TZ=Europe/London
    - date
    # - sudo ntpdate ntp.ubuntu.com
    - '[ ! -z "$DOCKER_PASS" ] && { echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin; } || :'

services:
  - docker
  - xvfb

jobs:
  include:
    - # PR builds - phpunit
      if: type = pull_request
      script: PUID=$(id -u) BUILD_BRANCH=$TRAVIS_PULL_REQUEST_BRANCH docker-compose -f protected/tests/docker-compose.yml run --use-aliases web
      name: "All tests"
    - # Branch builds - phpunit fixtures
      if: type = push AND (branch in (master, develop) OR branch =~ /^release\/\S*$/ OR branch =~ /^bugfix\/\S*$/)
      script: PUID=$(id -u) BUILD_BRANCH=$TRAVIS_BRANCH docker-compose -f protected/tests/docker-compose.yml run --use-aliases web
      name: "All tests (branch)"

