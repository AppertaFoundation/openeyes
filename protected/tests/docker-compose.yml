version: "3.4"

# NOTE is is recommended to run `docker-compose down` before `docker-compose up` This will ensure that the database is refreshed on each run.
# E.g, docker-compose down && docker-compose up
#
# To see individual logs - use docker-compose logs [db | web ]
#
## Note that an xvfb service service is needed for the cypress tests
#
#
## If you want to run this file locally (e.g, to mimic the CI environment)
# 1. Make sure to delete the following local directories first:
#    - ./protected/files
#    - ./node_modules
#    - ./protected/modules/eyedraw
#    - ./protected/runtime/cache
#    - ./assets
#    ( a helper script is provided alongside this compose file named clear-assets-before-tests.sh )
# 2. [Optional, probably not needed unless you have trouble with cy:open] Set a local environment variable for display to match your local XWindows server
#    - e.g., `export DISPLAY="host.docker.internal:0"

services:
  db:
    image: toukanlabsdocker/oe-sample-db:mariadb_10.5-6.6.0
    environment:
      MYSQL_ROOT_PASSWORD: openeyes
      TZ: "Europe/London"
    stdin_open: true
    tty: true
    ports:
      - "3333:3306"
    command:
      # Changing log_file_size to allow lightning image processing of larger document image events
      - "--innodb_log_file_size"
      - "128M"
      # disable binary logging (as not needed for development, but logs MUST be enabled for production)
      - "--disable-log-bin"
    volumes:
      - "protected-files:/protected/files"

  web:
    image: toukanlabsdocker/oe-web-dev:php7.4
    environment:
      OE_MODE: "TEST"
      TESTS_TO_RUN: "PHPUNIT-SAMPLE;CYPRESS_SHORT;PHPUNIT-FIXTURES"
      # TESTS_TO_RUN: "CYPRESS_SHORT;WAIT_APACHE"
      OE_QUIET_DEBUG_LOG: "TRUE"
      OUTPUT_APPLICATION_LOGS: "FALSE"
      XDEBUG_MODE: "off"
      OE_FORCE_MIGRATE: "TRUE"
      SKIP_OE_CLONE: "TRUE"
      GENERATE_TEMP_SODIUM_CRYPTO_KEY: "TRUE"
      DATABASE_HOST: "db"
      MYSQL_ROOT_PASSWORD: openeyes
      WAIT_HOSTS_TIMEOUT: "120"
      WAIT_SLEEP_INTERVAL: "2"
      USE_DEMO_DATA: "FALSE"
      DATABASE_NAME: "openeyes"
      DATABASE_USER: "openeyes"
      DATABASE_PASS: "openeyes"
      OE_INSTITUTION_CODE: "NEW"
      DISPLAY: "${DISPLAY:-:99.0}"
      BUILD_BRANCH: "${BUILD_BRANCH:-master}"
      PUID: ${PUID:-1000}
    secrets:
      - source: SSH_PRIVATE_KEY
    stdin_open: true
    tty: true
    depends_on:
     - "db"
    volumes:
      - "../..:/var/www/openeyes:delegated"
      - "/tmp/.X11-unix:/tmp/.X11-unix"
      - "protected-files:/protected/files"
    ports:
      - "8080:80"

volumes:
  protected-files:
secrets:
  SSH_PRIVATE_KEY:
    file: ~/.ssh/id_rsa
